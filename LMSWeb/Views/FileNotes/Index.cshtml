@model LMSWeb.ViewModel.CRMNotesViewModel
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutCRM.cshtml";
}


@using (Html.BeginForm("AddNotes", "FileNotes", FormMethod.Post, new { enctype = "multipart/form-data", id = "frmaddNotes", @class = "multisteps-form__form" }))
{

<div class="multisteps-form__panel shadow p-4 list-box bg-white" data-animation="scaleIn">
    <h5 class="multisteps-form__title">File Notes</h5>

    @Html.DropDownListFor(model => model.objCRMnotes.ClientId, new SelectList(Model.lstCRMclient, "Value", "Text"), "Select Client", htmlAttributes: new { id = "ddlclientlist", @class = "input150" })


    <div class="multisteps-form__content">
       
        @Html.TextAreaFor(model => model.objCRMnotes.Notes, new { @class = "input150", id = "txtnotes" })

    </div>


    <br />
    <div class="button-row d-flex mt-4">
        <button type="button" id="btnReplySubmit" class="btn btn-primary ml-auto js-btn-next"> Save Changes</button>
        
    </div>
    <br />



</div>

    <div id="dvClientNotes">

        @Html.Partial("~/Views/FileNotes/_NotesList.cshtml", Model)

    </div>
}
@*<script src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css'></script>*@
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.15/dist/summernote.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.15/dist/summernote.min.js"></script>
@*<script src="~/assets/CRM/scriptSteps.js"></script>*@
@*<link href="~/assets/CRM/styleSteps.css" rel="stylesheet" />*@


<script>
    $(document).ready(function () {
        $('#txtnotes').summernote();

        $('#btnReplySubmit').on("click", function () {
            AddReplyToDB();
        });
    });
    //function OnSuccess() {
    $('#ddlclientlist').change(function () {
        $('#ddlclientlist option').each(function (index) {
            if (($(this).is(':selected'))) {
                var id = this.value;
                console.log(id);
                GetNotes(id);
            }
        });
    });

    function GetNotes(id) {
        $.ajax({
            type: "POST",
            url: "/FileNotes/LoadNotes",
            data: '{Id: ' + JSON.stringify(id) + '}',
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {

                console.log(response);
                $('#dvClientNotes').html(response);


            },
            failure: function (response) {
            },
            error: function (response) {
                console.log(response);
                // toastr.success("Successfully moved to Potential Client");
                //  $('#dvActivityData').html(response.responseText);
                $('#dvClientNotes').html(response.responseText);
            }


        });
    }
   // }
    function AddReplyToDB() {
       
        var e = document.getElementById("ddlclientlist");
        var strUser = e.options[e.selectedIndex].value;

        if ($('#txtnotes').val() == null || $('#txtnotes').val() == ' ') {
            swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Please enter your comment!'
            })
        }
                 
         else if (strUser == 0) {
            swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Please select the Client!'
            })
            }        
        else {

            var data = $('#frmaddNotes').serialize();
            console.log(data);
            $.ajax({
                url: $('#frmaddNotes').attr('action'),
                type: 'post',
                dataType: "html",
                data: data,
                success: function (data) {
                    console.log(data)
                    if (data == "True") {
                        toastr.success("Notes Added");
                        //console.log(sucess);
                        $('#ddlclientlist option').each(function (index) {
                            if (($(this).is(':selected'))) {
                                var id = this.value;
                                console.log(id);
                                GetNotes(id);
                                $('#txtnotes').val() == '';
                                
                            }
                        });
                    }
                    else {
                        toastr.error('error occured while adding data');
                    }
                    //// for success - green box
                    //toastr.success('Success messages');

                    //// for errors - red box
                    //toastr.error('errors messages');

                    //// for warning - orange box
                    //toastr.warning('warning messages');

                    //// for info - blue box
                    //toastr.info('info messages');
                }
            });
        }
    }
</script>
